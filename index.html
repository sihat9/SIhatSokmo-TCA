<!DOCTYPE html>
<html lang="ms">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Appointment Klinik SihatSokmo</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- SheetJS untuk export Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #f0fdf4 0, #f8fafc 45%, #f0fdf4 100%);
      min-height: 100vh;
    }

    .tab-hidden {
      display: none;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .tab-btn-premium {
      border-radius: 10px;
      padding: 8px 16px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    /* Calendar Styles */
    #availabilityCalendarModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: none;
      flex-direction: column;
    }

    .calendar-header {
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 20px;
    }

    .calendar-day-header {
      text-align: center;
      padding: 10px 0;
      font-weight: 600;
      color: #64748b;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      border: 1px solid #f1f5f9;
    }

    .calendar-day:hover:not(.empty) {
      background-color: #f0fdf4;
      transform: scale(1.05);
    }

    .calendar-day.selected {
      background-color: #10b981;
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
    }

    .calendar-day.has-time::after {
      content: '';
      position: absolute;
      bottom: 6px;
      width: 4px;
      height: 4px;
      background: currentColor;
      border-radius: 50%;
    }

    /* Time Slot Picker */
    .time-slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .time-slot {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      background: white;
    }

    .time-slot:hover {
      border-color: #10b981;
      color: #10b981;
    }

    .time-slot.selected {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .time-slot.booked {
      background: #fee2e2;
      color: #991b1b;
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Floating Table */
    #availabilityTableContainer {
      position: absolute;
      z-index: 50;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      margin-top: 4px;
    }

    .availability-date-item {
      padding: 10px 15px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .availability-date-item:hover {
      background: #f0fdf4;
    }

    /* Loading Spinner */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #10b981;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="text-slate-900">

  <!-- APP CONTAINER -->
  <div class="min-h-screen flex flex-col items-center px-4 py-6 md:px-8 md:py-8">
    <div
      class="w-full max-w-7xl bg-white/90 border border-slate-200 rounded-2xl shadow-xl shadow-emerald-100 p-5 md:p-8 backdrop-blur">

      <!-- HEADER -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div class="space-y-2">
          <div
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-sm border border-emerald-100">
            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            <span>Sistem Klinik Pintar</span>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">Klinik SihatSokmo</h1>
          <p class="text-slate-500">Portal Pengurusan Temujanji & Jadual Doktor</p>
        </div>
        <div class="text-right space-y-2">
          <div id="userInfo" class="font-semibold text-slate-700">Belum log masuk</div>
          <button id="logoutBtn" class="hidden text-sm text-rose-600 hover:text-rose-700 font-medium">Log
            Keluar</button>
        </div>
      </div>

      <!-- NAVIGATION -->
      <div id="navTabs" class="hidden flex flex-wrap gap-2 border-b border-slate-100 pb-1 mb-6">
        <button data-tab="tab-staff" id="btnStaff"
          class="tab-btn tab-btn-premium text-slate-500 hover:bg-emerald-50 hover:text-emerald-600">Staff
          Klinik</button>
        <button data-tab="tab-doctor" id="btnDoctor"
          class="tab-btn tab-btn-premium text-slate-500 hover:bg-emerald-50 hover:text-emerald-600">Doktor
          Pakar</button>
        <button data-tab="tab-export" id="btnExport"
          class="tab-btn tab-btn-premium text-slate-500 hover:bg-emerald-50 hover:text-emerald-600">Laporan &
          Export</button>
        <button data-tab="tab-settings" id="btnSettings"
          class="tab-btn tab-btn-premium text-slate-500 hover:bg-emerald-50 hover:text-emerald-600">Tetapan</button>
      </div>

      <!-- 1. LOGIN SECTION -->
      <section id="tab-login">
        <div class="max-w-md mx-auto mt-10 p-8 border border-slate-200 rounded-2xl shadow-lg bg-white">
          <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Log Masuk Kakitangan</h2>
          <form id="loginForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
              <input type="email" id="loginEmail" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label>
              <input type="password" id="loginPassword" required
                class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition">
            </div>
            <button type="submit"
              class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
              Log Masuk
            </button>
            <p id="loginError" class="text-center text-sm text-rose-500 hidden"></p>
          </form>
        </div>
      </section>

      <!-- 2. STAFF PANEL -->
      <section id="tab-staff" class="tab-hidden">
        <div class="grid lg:grid-cols-12 gap-6">
          <!-- New Appointment Form (Left) -->
          <div class="lg:col-span-4 space-y-6">
            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <span>‚ûï</span> Daftar Temujanji
              </h3>
              <form id="appointmentForm" class="space-y-4">

                <!-- Service Selection -->
                <div>
                  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Servis</label>
                  <select id="serviceSelect"
                    class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50">
                    <option value="">Pilih Servis...</option>
                  </select>
                </div>

                <!-- Doctor Selection with Availability Popover -->
                <div class="relative">
                  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Doktor</label>
                  <select id="doctorSelect"
                    class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-slate-50">
                    <option value="">Pilih Doktor...</option>
                  </select>
                  <!-- Hidden Availability Table -->
                  <div id="availabilityTableContainer">
                    <div class="p-2 bg-slate-50 border-b text-xs font-bold text-slate-500 uppercase">Tarikh Available
                    </div>
                    <div id="availabilityList" class="text-sm"></div>
                  </div>
                </div>

                <!-- Patient Details -->
                <div class="space-y-3 pt-2 border-t border-slate-100">
                  <input id="patientName" required placeholder="Nama Pesakit"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-emerald-500 outline-none">
                  <div class="grid grid-cols-2 gap-3">
                    <input id="patientIC" required placeholder="No. IC / KP"
                      class="w-full px-3 py-2 border rounded-lg focus:ring-emerald-500 outline-none">
                    <input id="patientPhone" required placeholder="No. Tel"
                      class="w-full px-3 py-2 border rounded-lg focus:ring-emerald-500 outline-none">
                  </div>
                </div>

                <!-- Date & Time -->
                <div class="pt-2 border-t border-slate-100">
                  <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Tarikh & Masa</label>
                  <input type="date" id="requestedDate" required
                    class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring-emerald-500 outline-none mb-3">
                  <div id="timeSlotLoader" class="hidden text-center py-2">
                    <div class="loader mx-auto"></div>
                  </div>
                  <div id="timeSlotContainer" class="time-slot-grid max-h-40 overflow-y-auto scrollbar-thin p-1">
                    <!-- Time slots rendered here -->
                  </div>
                  <input id="customTime" placeholder="Atau masa manual (pilihan)"
                    class="w-full mt-2 px-3 py-2 text-sm border rounded-lg focus:ring-emerald-500 outline-none">
                </div>

                <textarea id="complaint" rows="2" placeholder="Ringkasan masalah / aduan..."
                  class="w-full px-3 py-2 border rounded-lg focus:ring-emerald-500 outline-none text-sm"></textarea>
                <div id="customFieldsContainer" class="space-y-3"></div>

                <button type="submit"
                  class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg shadow transition">
                  Simpan Temujanji
                </button>
              </form>
            </div>
          </div>

          <!-- Lists & Actions (Right) -->
          <div class="lg:col-span-8 space-y-6">

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-4">
              <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl">
                <div class="text-amber-600 text-sm font-bold">Pending</div>
                <div class="text-2xl font-bold text-amber-800" id="statPending">0</div>
              </div>
              <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-xl">
                <div class="text-emerald-600 text-sm font-bold">Approved</div>
                <div class="text-2xl font-bold text-emerald-800" id="statApproved">0</div>
              </div>
              <div class="bg-rose-50 border border-rose-100 p-4 rounded-xl">
                <div class="text-rose-600 text-sm font-bold">Rejected</div>
                <div class="text-2xl font-bold text-rose-800" id="statRejected">0</div>
              </div>
            </div>

            <!-- Appointment List -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">Senarai Temujanji</h3>
                <div class="flex gap-2 text-sm">
                  <button class="staff-filter-btn px-3 py-1 rounded-full bg-slate-100 text-slate-600 font-medium"
                    data-status="pending">Pending</button>
                  <button class="staff-filter-btn px-3 py-1 rounded-full bg-slate-100 text-slate-600 font-medium"
                    data-status="approved">Approved</button>
                  <button class="staff-filter-btn px-3 py-1 rounded-full bg-slate-100 text-slate-600 font-medium"
                    data-status="rejected">Rejected</button>
                  <button id="refreshStaffBtn" class="px-3 py-1 rounded-full border hover:bg-slate-50">üîÑ</button>
                </div>
              </div>
              <div id="staffAppointmentsList" class="space-y-3 max-h-[600px] overflow-y-auto scrollbar-thin"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. DOCTOR PANEL -->
      <section id="tab-doctor" class="tab-hidden">
        <div class="grid lg:grid-cols-1 gap-6">
          <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
              <div>
                <h2 class="text-xl font-bold text-slate-800">Pengurusan Temujanji</h2>
                <p class="text-slate-500 text-sm">Urus temujanji dan jadual anda.</p>
              </div>
              <button id="doctorAvailabilityBtn"
                class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition">
                <span>üìÖ</span> Kemaskini Jadual
              </button>
            </div>

            <!-- Batch Action Bar -->
            <div id="batchActionBar"
              class="hidden bg-slate-900 text-white p-4 rounded-lg mb-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-lg">
              <div class="font-bold flex items-center gap-3">
                <span class="bg-emerald-500 text-xs px-2 py-1 rounded">Batch Mode</span>
                <span id="batchCount">0 dipilih</span>
              </div>

              <div class="flex gap-2 w-full md:w-auto">
                <!-- Approve Batch -->
                <div class="flex-1 flex gap-1">
                  <input type="datetime-local" id="batchApproveTime"
                    class="text-slate-900 text-xs px-2 rounded-l w-32 border-none focus:ring-0">
                  <button id="btnBatchApprove"
                    class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1 text-xs font-bold rounded-r">Approve</button>
                </div>
                <!-- Reject Batch (Simple mode for batch, complex for single) -->
                <button id="btnBatchReject"
                  class="bg-rose-500 hover:bg-rose-600 px-3 py-1 text-xs font-bold rounded">Reject</button>
              </div>
              <button id="btnClearBatch" class="text-slate-400 hover:text-white text-xs">Batal</button>
            </div>

            <!-- Doctor Tabs -->
            <div class="flex border-b border-slate-100 mb-4">
              <button
                class="doctor-filter-btn px-6 py-3 border-b-2 font-bold text-emerald-600 border-emerald-500 bg-emerald-50"
                data-status="pending">Pending</button>
              <button
                class="doctor-filter-btn px-6 py-3 border-b-2 border-transparent text-slate-500 hover:text-emerald-600"
                data-status="approved">Approved</button>
              <button
                class="doctor-filter-btn px-6 py-3 border-b-2 border-transparent text-slate-500 hover:text-emerald-600"
                data-status="rejected">Rejected</button>
            </div>

            <div id="doctorCardsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- Cards will be injected here -->
            </div>
          </div>
        </div>
      </section>

      <!-- 4. EXPORT PANEL -->
      <section id="tab-export" class="tab-hidden">
        <div class="max-w-2xl mx-auto bg-white border border-slate-200 rounded-xl p-8">
          <h2 class="text-2xl font-bold mb-6">Laporan & Export Data</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Pilih Doktor</label>
              <select id="exportDoctorSelect" class="w-full px-4 py-3 border rounded-lg bg-slate-50">
                <option value="all">Semua Doktor</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                <select id="exportMonth" class="w-full px-4 py-3 border rounded-lg">
                  <option value="all">Semua</option>
                  <option value="0">Januari</option>
                  <option value="1">Februari</option>
                  <option value="2">Mac</option>
                  <option value="3">April</option>
                  <option value="4">Mei</option>
                  <option value="5">Jun</option>
                  <option value="6">Julai</option>
                  <option value="7">Ogos</option>
                  <option value="8">September</option>
                  <option value="9">Oktober</option>
                  <option value="10">November</option>
                  <option value="11">Disember</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                <select id="exportYear" class="w-full px-4 py-3 border rounded-lg"></select>
              </div>
            </div>
            <button id="runExportBtn"
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg flex justify-center items-center gap-2">
              üìÑ Muat Turun Excel
            </button>
          </div>
        </div>
      </section>

      <!-- 5. SETTINGS PANEL -->
      <section id="tab-settings" class="tab-hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Add Service -->
          <div class="bg-white border rounded-xl p-6">
            <h3 class="font-bold text-lg mb-4">Urus Servis</h3>
            <form id="addServiceForm" class="flex gap-2 mb-4">
              <input id="newServiceName" required placeholder="Nama Servis Baru"
                class="flex-1 px-3 py-2 border rounded-lg">
              <button type="submit" class="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold">+</button>
            </form>
            <div id="serviceListSettings" class="space-y-2 max-h-60 overflow-y-auto"></div>
          </div>
          <!-- Custom Fields -->
          <div class="bg-white border rounded-xl p-6">
            <h3 class="font-bold text-lg mb-4">Kolom Tambahan (Custom Fields)</h3>
            <form id="addFieldForm" class="space-y-3 mb-4">
              <input id="newFieldLabel" required placeholder="Nama Label (cth: Umur)"
                class="w-full px-3 py-2 border rounded-lg">
              <div class="flex gap-2">
                <select id="newFieldType" class="flex-1 px-3 py-2 border rounded-lg">
                  <option value="text">Teks</option>
                  <option value="number">Nombor</option>
                  <option value="date">Tarikh</option>
                </select>
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold">Tambah</button>
              </div>
            </form>
            <div id="fieldsListSettings" class="space-y-2 max-h-60 overflow-y-auto"></div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- DOCTOR CALENDAR MODAL (FULL SCREEN) -->
  <div id="availabilityCalendarModal">
    <!-- Header -->
    <div class="calendar-header shadow-md">
      <button id="calBackBtn" class="flex items-center gap-2 text-white/90 hover:text-white font-semibold">
        ‚¨Ö Kembali
      </button>
      <div class="text-center">
        <h2 class="text-xl font-bold">Tetapan Jadual</h2>
        <p class="text-emerald-100 text-sm">Pilih tarikh & tetapkan masa</p>
      </div>
      <button id="calSaveBtn"
        class="bg-white text-emerald-600 px-5 py-2 rounded-lg font-bold shadow-lg hover:bg-emerald-50 transition">
        Simpan Jadual
      </button>
    </div>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-slate-50">
      <!-- Calendar Grid (Left) -->
      <div class="flex-1 overflow-y-auto p-4 md:p-8">
        <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <div class="flex justify-between items-center mb-6">
            <button id="prevMonthBtn" class="p-2 hover:bg-slate-100 rounded-full">‚óÄ</button>
            <h3 id="calendarMonthTitle" class="text-xl font-bold text-slate-800 capitalize"></h3>
            <button id="nextMonthBtn" class="p-2 hover:bg-slate-100 rounded-full">‚ñ∂</button>
          </div>
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>
      </div>

      <!-- Side Panel (Right) -->
      <div class="w-full md:w-80 bg-white border-l border-slate-200 p-6 overflow-y-auto shadow-xl z-20">
        <h3 class="font-bold text-slate-800 mb-4">Pengurusan Slot</h3>

        <!-- Current Selection Info -->
        <div class="mb-6 p-4 bg-emerald-50 rounded-xl border border-emerald-100">
          <div class="text-xs font-bold text-emerald-600 uppercase mb-1">Dipilih</div>
          <div id="selectedCountDisplay" class="text-2xl font-bold text-slate-800">0 Hari</div>
          <button id="clearSelectionBtn" class="text-xs text-rose-500 font-bold mt-2 hover:underline">Kosongkan
            Pilihan</button>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkControls" class="opacity-50 pointer-events-none transition-opacity">
          <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tetapkan Masa (Semua yg dipilih)</label>

          <div class="grid grid-cols-2 gap-2 mb-4">
            <button class="bulk-btn bg-white border hover:border-emerald-500 text-left px-3 py-2 rounded-lg text-sm"
              data-type="morning">
              <span class="block font-bold">Pagi</span>
              <span class="text-xs text-slate-500">08:00 - 12:00</span>
            </button>
            <button class="bulk-btn bg-white border hover:border-emerald-500 text-left px-3 py-2 rounded-lg text-sm"
              data-type="afternoon">
              <span class="block font-bold">Petang</span>
              <span class="text-xs text-slate-500">14:00 - 18:00</span>
            </button>
            <button class="bulk-btn bg-white border hover:border-emerald-500 text-left px-3 py-2 rounded-lg text-sm"
              data-type="evening">
              <span class="block font-bold">Malam</span>
              <span class="text-xs text-slate-500">18:00 - 22:00</span>
            </button>
            <button class="bulk-btn bg-white border hover:border-emerald-500 text-left px-3 py-2 rounded-lg text-sm"
              data-type="full">
              <span class="block font-bold">Full Day</span>
              <span class="text-xs text-slate-500">08:00 - 22:00</span>
            </button>
          </div>

          <div class="border-t border-slate-100 my-4 pt-4">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Pilih Slot Individu</label>
            <div id="calTimeSlotPicker" class="time-slot-grid max-h-40 overflow-y-auto"></div>
          </div>

          <button id="removeAvailabilityBtn"
            class="w-full mt-4 border border-rose-200 text-rose-600 bg-rose-50 hover:bg-rose-100 py-2 rounded-lg font-bold text-sm">
            ‚ùå Padam Masa (Set Off)
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://rzcrbseoiqbgkhprdbbz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Y3Jic2VvaXFiZ2tocHJkYmJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NTk5MDksImV4cCI6MjA4MTAzNTkwOX0.C5AHYqGKywrfOf2uEwZZUSYGByuLE_PKfImS7nuFKrs";
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- STATE ---
    let user = null;
    let profile = null;
    let services = [];
    let doctors = [];

    // Calendar State
    let calMonth = new Date().getMonth();
    let calYear = new Date().getFullYear();
    let calSelectedDates = new Set();
    let calDateTimes = new Map(); // dateStr -> array of times ["08:00", "08:30"...] or ["full"]

    // Batch State
    let batchSelection = new Set();

    // --- INIT ---
    async function init() {
      const { data } = await db.auth.getUser();
      user = data.user;

      if (user) {
        const { data: p } = await db.from("profiles").select("*").eq("id", user.id).single();
        profile = p;
        document.getElementById("userInfo").textContent = \`\${profile.full_name} (\${profile.role})\`;
      document.getElementById("userInfo").classList.remove("text-rose-500");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("navTabs").classList.remove("hidden");
      document.getElementById("tab-login").classList.add("tab-hidden");
      
      await loadMetadata();

      if (profile.role === 'staff') {
        switchTab('tab-staff');
        loadStaffView();
      } else {
        switchTab('tab-doctor');
        loadDoctorView();
      }
    } else {
      switchTab('tab-login');
    }
  }

  // --- AUTH ---
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPassword").value;
    
    const { error } = await db.auth.signInWithPassword({ email, password: pass });
    if(error) {
      document.getElementById("loginError").textContent = error.message;
      document.getElementById("loginError").classList.remove("hidden");
    } else {
      location.reload();
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await db.auth.signOut();
    location.reload();
  });

  // --- NAVIGATION ---
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  function switchTab(id) {
    document.querySelectorAll("section").forEach(s => s.classList.add("tab-hidden"));
    document.getElementById(id).classList.remove("tab-hidden");
    
    document.querySelectorAll(".tab-btn").forEach(btn => {
      if(btn.dataset.tab === id) btn.classList.add("text-emerald-600", "bg-emerald-50");
      else btn.classList.remove("text-emerald-600", "bg-emerald-50");
    });
  }

  // --- DATA LOADING ---
  async function loadMetadata() {
    const [sData, dData] = await Promise.all([
      db.from("services").select("*").eq("status", "active"),
      db.from("profiles").select("*").eq("role", "doctor")
    ]);
    services = sData.data || [];
    doctors = dData.data || [];
    
    // Fill Selects
    const sSelect = document.getElementById("serviceSelect");
    sSelect.innerHTML = '<option value="">Pilih Servis...</option>';
    services.forEach(s => sSelect.add(new Option(s.name, s.id)));

    const dSelect = document.getElementById("doctorSelect");
    dSelect.innerHTML = '<option value="">Pilih Doktor...</option>';
    doctors.forEach(d => dSelect.add(new Option(d.full_name, d.id)));

    const expDSelect = document.getElementById("exportDoctorSelect");
    doctors.forEach(d => expDSelect.add(new Option(d.full_name, d.id)));
  }

  // --- STAFF VIEW ---
  async function loadStaffView() {
    loadStaffAppointments("pending");
    updateStats();
    
    // Doctor Select Listener for Quick Availability
    document.getElementById("doctorSelect").addEventListener("change", async (e) => {
      const docId = e.target.value;
      const container = document.getElementById("availabilityTableContainer");
      if(!docId) { container.style.display = 'none'; return; }
      
      container.style.display = 'block';
      const list = document.getElementById("availabilityList");
      list.innerHTML = '<div class="p-2 text-slate-400">Loading...</div>';
      
      const { data } = await db.from("doctor_availability")
        .select("*")
        .eq("doctor_id", docId)
        .gte("date", new Date().toISOString().split("T")[0])
        .order("date")
        .limit(10);
      
      list.innerHTML = "";
      if(!data || data.length === 0) list.innerHTML = '<div class="p-2 text-rose-500">Tiada Jadual.</div>';
      
      data.forEach(av => {
        const div = document.createElement("div");
        div.className = "availability-date-item";
        div.innerHTML = \`
          <span>\${av.date}</span>
          <span class="text-emerald-600 font-bold">\${av.is_full_day ? 'Full' : (av.start_time || 'Flex')}</span>
        \`;
        div.onclick = () => {
          document.getElementById("requestedDate").value = av.date;
          container.style.display = 'none';
          loadTimeSlotsForStaff(docId, av.date);
        };
        list.appendChild(div);
      });
    });

    document.getElementById("requestedDate").addEventListener("change", () => {
      const doc = document.getElementById("doctorSelect").value;
      const date = document.getElementById("requestedDate").value;
      if(doc && date) loadTimeSlotsForStaff(doc, date);
    });
  }

  async function loadTimeSlotsForStaff(doctorId, date) {
    const list = document.getElementById("timeSlotContainer");
    const loader = document.getElementById("timeSlotLoader");
    list.innerHTML = ''; loader.classList.remove("hidden");
    
    // 1. Get Doctor Availability for that day
    const { data: avData } = await db.from("doctor_availability")
      .select("*")
      .eq("doctor_id", doctorId)
      .eq("date", date)
      .single();
    
    // 2. Get Booked Slots
    const { data: bookings } = await db.from("appointments")
      .select("requested_time")
      .eq("doctor_id", doctorId)
      .eq("requested_date", date)
      .neq("status", "rejected");
      
    const bookedTimes = new Set(bookings?.map(b => b.requested_time) || []);
    
    // Generate Slots
    let slots = [];
    if (!avData) {
       // No availability set -> Show "No slots"
       list.innerHTML = '<div class="col-span-full text-center text-sm text-slate-500 p-2">Doktor tidak menetapkan jadual pada tarikh ini.</div>';
       loader.classList.add("hidden");
       return;
    }

    if (avData.is_full_day) {
      slots = generateTimeRange("09:00", "17:00");
    } else if (avData.start_time && avData.end_time) {
      slots = generateTimeRange(avData.start_time, avData.end_time);
    } else {
      slots = generateTimeRange("09:00", "17:00"); // Default fallback
    }

    slots.forEach(time => {
      const div = document.createElement("div");
      div.className = "time-slot " + (bookedTimes.has(time) ? "booked" : "");
      div.textContent = formatTime(time);
      if(!bookedTimes.has(time)) {
        div.onclick = () => {
          document.querySelectorAll("#timeSlotContainer .selected").forEach(s => s.classList.remove("selected"));
          div.classList.add("selected");
          document.getElementById("customTime").value = time;
        };
      }
      list.appendChild(div);
    });
    
    loader.classList.add("hidden");
  }

  function generateTimeRange(start, end) {
    let times = [];
    let current = start;
    while(current < end) {
      times.push(current);
      let [h, m] = current.split(":").map(Number);
      m += 30; if(m>=60){h++; m=0;}
      current = \`\${String(h).padStart(2,'0')}:\${String(m).padStart(2,'0')}\`;
    }
    return times;
  }

  // --- APPOINTMENT SUBMISSION ---
  document.getElementById("appointmentForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      service_id: document.getElementById("serviceSelect").value,
      doctor_id: document.getElementById("doctorSelect").value,
      patient_name: document.getElementById("patientName").value,
      patient_ic: document.getElementById("patientIC").value,
      patient_phone: document.getElementById("patientPhone").value,
      requested_date: document.getElementById("requestedDate").value,
      requested_time: document.getElementById("customTime").value,
      complaint: document.getElementById("complaint").value,
      status: 'pending'
    };
    
    const { error } = await db.from("appointments").insert(payload);
    if(error) alert("Error: " + error.message);
    else {
      alert("Temujanji berjaya didaftarkan!");
      e.target.reset();
      loadStaffAppointments("pending");
      updateStats();
    }
  });

  // --- STAFF LIST ---
  async function loadStaffAppointments(status) {
    const list = document.getElementById("staffAppointmentsList");
    list.innerHTML = '<div class="text-center p-4">Loading...</div>';
    
    let q = db.from("appointments").select("*, profiles(full_name), services(name)").order("created_at", {ascending:false});
    if(status) q = q.eq("status", status);
    
    const { data } = await q;
    renderAppointmentList(list, data, true); // true = staff mode
  }

  document.querySelectorAll(".staff-filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
       document.querySelectorAll(".staff-filter-btn").forEach(b => b.classList.replace("bg-emerald-100", "bg-slate-100"));
       document.querySelectorAll(".staff-filter-btn").forEach(b => b.classList.replace("text-emerald-700", "text-slate-600"));
       
       btn.classList.replace("bg-slate-100", "bg-emerald-100");
       btn.classList.replace("text-slate-600", "text-emerald-700");
       loadStaffAppointments(btn.dataset.status);
    });
  });

  // --- DOCTOR VIEW ---
  async function loadDoctorView() {
    loadDoctorAppointments("pending");
  }

  async function loadDoctorAppointments(status) {
    const container = document.getElementById("doctorCardsContainer");
    container.innerHTML = '<div class="text-center p-8 col-span-full">Loading...</div>';
    
    let q = db.from("appointments").select("*").eq("doctor_id", profile.id).order("requested_date");
    if(status) q = q.eq("status", status);
    
    const { data } = await q;
    container.innerHTML = "";
    
    if(!data || data.length === 0) {
      container.innerHTML = '<div class="text-center p-8 col-span-full text-slate-500 bg-slate-50 rounded-lg">Tiada temujanji dalam kategori ini.</div>';
      return;
    }

    data.forEach(app => {
      const card = document.createElement("div");
      card.className = "bg-white p-5 rounded-xl border border-slate-200 shadow-sm card-hover relative";
      
      const isPending = app.status === 'pending';
      const dateDisplay = app.doctor_selected_date ? new Date(app.doctor_selected_date).toLocaleString() : \`\${app.requested_date} @ \${app.requested_time}\`;

      card.innerHTML = \`
        <div class="flex justify-between items-start mb-3">
          <div class="flex items-center gap-3">
             \${isPending ? \`<input type="checkbox" class="w-5 h-5 batch-checkbox" value="\${app.id}">\` : ''}
             <div class="font-bold text-lg text-slate-800">\${app.patient_name}</div>
          </div>
          <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100 uppercase">\${app.status}</span>
        </div>
        <div class="text-sm text-slate-600 mb-4 space-y-1">
          <div>üóìÔ∏è \${dateDisplay}</div>
          <div>üì± \${app.patient_phone}</div>
          <div>üìù \${app.complaint || '-'}</div>
        </div>
        \${isPending ? \`
        <div class="flex gap-2 mt-auto pt-3 border-t border-slate-50">
           <button onclick="quickAction('\${app.id}', 'approve')" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-2 rounded-lg font-bold text-sm">Approve</button>
           <button onclick="quickAction('\${app.id}', 'reject')" class="flex-1 bg-rose-50 text-rose-600 hover:bg-rose-100 py-2 rounded-lg font-bold text-sm">Reject</button>
        </div>
        \` : ''}
      \`;
      container.appendChild(card);
    });

    // Batch Checkbox Logic
    document.querySelectorAll(".batch-checkbox").forEach(cb => {
      cb.addEventListener("change", (e) => {
        if(e.target.checked) batchSelection.add(e.target.value);
        else batchSelection.delete(e.target.value);
        updateBatchUI();
      });
    });
  }

  function updateBatchUI() {
    const bar = document.getElementById("batchActionBar");
    const count = batchSelection.size;
    document.getElementById("batchCount").textContent = count + " Dipilih";
    if(count > 0) bar.classList.remove("hidden");
    else bar.classList.add("hidden");
  }

  // --- DOCTOR CALENDAR LOGIC (ROBUST) ---
  document.getElementById("doctorAvailabilityBtn").addEventListener("click", () => {
    document.getElementById("availabilityCalendarModal").style.display = 'flex';
    calSelectedDates.clear(); calDateTimes.clear();
    renderCalendar();
    loadExistingAvailability();
  });
  
  document.getElementById("calBackBtn").addEventListener("click", () => document.getElementById("availabilityCalendarModal").style.display = 'none');

  function renderCalendar() {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";
    document.getElementById("calendarMonthTitle").textContent = new Date(calYear, calMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
    
    // Header
    const days = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
    days.forEach(d => {
      const h = document.createElement("div"); h.className = "calendar-day-header"; h.textContent = d.substr(0,3);
      grid.appendChild(h);
    });

    const firstDay = new Date(calYear, calMonth, 1);
    const lastDay = new Date(calYear, calMonth + 1, 0);

    // Padding
    for(let i=0; i<firstDay.getDay(); i++) grid.appendChild(document.createElement("div"));

    // Days
    for(let d=1; d<=lastDay.getDate(); d++) {
      const dateStr = \`\${calYear}-\${String(calMonth+1).padStart(2,'0')}-\${String(d).padStart(2,'0')}\`;
      const el = document.createElement("div");
      el.className = "calendar-day";
      el.textContent = d;
      
      if(calSelectedDates.has(dateStr)) {
        el.classList.add("selected");
        if(calDateTimes.has(dateStr) && calDateTimes.get(dateStr).length > 0) el.classList.add("has-time");
      }
      
      el.onclick = () => {
        if(calSelectedDates.has(dateStr)) calSelectedDates.delete(dateStr);
        else { calSelectedDates.add(dateStr); if(!calDateTimes.has(dateStr)) calDateTimes.set(dateStr, []); }
        renderCalendar();
        updateCalPanel();
      };
      grid.appendChild(el);
    }
  }
  
  document.getElementById("prevMonthBtn").addEventListener("click", ()=>{calMonth--; if(calMonth<0){calMonth=11; calYear--;} renderCalendar();});
  document.getElementById("nextMonthBtn").addEventListener("click", ()=>{calMonth++; if(calMonth>11){calMonth=0; calYear++;} renderCalendar();});

  // Bulk Time Setters
  document.querySelectorAll(".bulk-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const type = btn.dataset.type;
      let times = [];
      if(type==='morning') times = generateTimeRange("08:00", "12:00");
      if(type==='afternoon') times = generateTimeRange("14:00", "18:00");
      if(type==='evening') times = generateTimeRange("18:00", "22:00");
      if(type==='full') times = ["full_day"];
      
      calSelectedDates.forEach(d => calDateTimes.set(d, times));
      renderCalendar();
      updateCalPanel();
    });
  });

  // Time Slot Picker Injection
  const picker = document.getElementById("calTimeSlotPicker");
  generateTimeRange("08:00", "22:00").forEach(t => {
    const d = document.createElement("div");
    d.className = "time-slot";
    d.textContent = formatTime(t);
    d.onclick = () => {
      // Add this time to all selected dates
      calSelectedDates.forEach(date => {
        let times = calDateTimes.get(date) || [];
        if(times.includes("full_day")) times = [];
        if(!times.includes(t)) times.push(t);
        calDateTimes.set(date, times);
      });
      renderCalendar();
    };
    picker.appendChild(d);
  });

  document.getElementById("removeAvailabilityBtn").addEventListener("click", () => {
    calSelectedDates.forEach(d => calDateTimes.set(d, []));
    renderCalendar();
  });

  function updateCalPanel() {
    const count = calSelectedDates.size;
    document.getElementById("selectedCountDisplay").textContent = count + " Hari";
    const controls = document.getElementById("bulkControls");
    if(count > 0) {
      controls.classList.remove("opacity-50", "pointer-events-none");
    } else {
      controls.classList.add("opacity-50", "pointer-events-none");
    }
  }

  // Load/Save Availability
  async function loadExistingAvailability() {
    const { data } = await db.from("doctor_availability").select("*")
      .eq("doctor_id", profile.id)
      .gte("date", new Date().toISOString().split("T")[0]);
    
    if(data) {
       data.forEach(item => {
         calSelectedDates.add(item.date);
         let times = [];
         if(item.is_full_day) times = ["full_day"];
         else if(item.start_time) times = generateTimeRange(item.start_time, item.end_time);
         calDateTimes.set(item.date, times);
       });
       renderCalendar();
    }
  }

  document.getElementById("calSaveBtn").addEventListener("click", async () => {
    if(!profile) return;
    
    // Clear future
    await db.from("doctor_availability").delete().eq("doctor_id", profile.id).gte("date", new Date().toISOString().split("T")[0]);
    
    const inserts = [];
    calDateTimes.forEach((times, date) => {
       if(!calSelectedDates.has(date)) return;
       if(times.includes("full_day")) {
         inserts.push({ doctor_id: profile.id, date, is_full_day: true, status: 'available' });
       } else if(times.length > 0) {
         times.sort();
         inserts.push({
           doctor_id: profile.id, date, 
           start_time: times[0], end_time: times[times.length-1],
           is_full_day: false, status: 'available'
         });
       }
    });
    
    if(inserts.length > 0) {
      const { error } = await db.from("doctor_availability").insert(inserts);
      if(error) alert("Error save: " + error.message);
      else { alert("Jadual disimpan!"); document.getElementById("availabilityCalendarModal").style.display = 'none'; }
    } else {
      alert("Tiada jadual untuk disimpan.");
    }
  });

  // --- HELPERS ---
  function renderAppointmentList(container, data, isStaff) {
    container.innerHTML = "";
    if(!data || data.length === 0) {
      container.innerHTML = '<div class="p-4 text-center text-slate-500">Tiada rekod.</div>';
      return;
    }
    data.forEach(app => {
      const div = document.createElement("div");
      div.className = "flex justify-between items-center p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50";
      div.innerHTML = \`
        <div>
           <div class="font-bold text-slate-800">\${app.patient_name}</div>
           <div class="text-xs text-slate-500">\${app.services?.name || 'Servis'} | \${app.requested_date} @ \${app.requested_time}</div>
        </div>
        <span class="text-xs font-bold px-2 py-1 rounded bg-slate-200 uppercase">\${app.status}</span>
      \`;
      container.appendChild(div);
    });
  }
  
  function updateStats() {
    ["pending", "approved", "rejected"].forEach(async s => {
      const { count } = await db.from("appointments").select("*", {count: 'exact', head: true}).eq("status", s);
      const el = document.getElementById("stat" + s.charAt(0).toUpperCase() + s.slice(1));
      if(el) el.textContent = count || 0;
    });
  }
  
  function formatTime(t) {
    if(!t) return "";
    const [h,m] = t.split(":");
    const ampm = h>=12?'PM':'AM';
    const h12 = h%12||12;
    return \`\${h12}:\${m} \${ampm}\`;
  }
  
  // Quick Actions (Placeholder logic for single approve/reject buttons)
  window.quickAction = async (id, action) => {
    const status = action === 'approve' ? 'approved' : 'rejected';
    await db.from("appointments").update({status}).eq("id", id);
    loadDoctorAppointments("pending");
  };

  // Run
  init();

  // Excel Export Placeholder
  document.getElementById("yearSelect")?.innerHTML = ""; // Populate in actual impl if needed
  
  </script>
</body>

</html>
